## Android Sqlite 多线程访问数据库的问题

### 出现问题

程序写多了，难免会跟数据打交道，会与 SQLite 不期而遇。刚接触数据库的时候，经常性的遇到一些问题。记录一下

* SQLiteDatabaseLockedException: database is locked

> SQLite3 对于并发的处理机制是允许同一个进程的多个线程同时读取一个数据库，但是任何时刻只允许一个线程/进程写入数据库，在做 写入 操作时，数据库文件被锁定，此时任何其他 读/写 操作都被阻塞，如果阻塞时间超过5秒（默认是5秒，可以修改超时时间），就会报 "database is locked" 错误。

解决办法：

对 DatabaseHelper 做单例模式，并加上同步锁。这样的话，同一个时刻只能有一个线程可以打开 Database。可以解决 database is locked 问题



* IllegalStateException: attempt to re-open an already-closed object.

虽然已经做了多线程同步锁，但是仍然会有多线程同时进行读取操作的情况出现，场景为

线程A打开数据，正在使用数据库，这时cpu片段分到线程B，线程A挂起。线程B进入执行获取打开db时没有问题，线程B进行操作，在片段时间内数据操作完成，最后关闭数据库database.close()。线程B执行结束，线程A执行，插入数据或者其他操作。这个时候 其实数据库已经被线程B关闭了，但是线程A还没有对数据库操作完成，所以出现问题。 

解决办法：

解决的主旨就是，我们要在所有人都不需要使用数据库的时候才去关闭它。很多人都说 StackOverflow 网站有推荐做法是：永远不要关闭数据库。（虽然我并没有看到）

但是不关闭数据库应该也是有问题的。

所以网友（程序员）的智慧是很厉害的。提供了一个大家都觉得很不错的解决办法：	

1. 管理一个 count 变量
2. 在每一次openDb 时 加1，在 count 为 1 ，也就是 第一次open时，实际打开数据库连接，其他时候不做操作
3. 在每一次closeDb 时减1，在count 为0 ，也就是之前的数据库连接都已经不需要了，再实际关闭数据库连接，其他时候不做操作。

这样的话，有一点 ~~永远~~不要关闭数据库的思想，但是又兼顾到了性能问题，关闭还是要关闭的，只是在所有人都不需要的时候关闭就好了。简直完美。

